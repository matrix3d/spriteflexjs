/**
 * Generated by Apache Royale Compiler from flash/__native/te/CharSet.as
 * flash.__native.te.CharSet
 *
 * @fileoverview
 *
 * @suppress {missingRequire|checkTypes|accessControls}
 */

goog.provide('flash.__native.te.CharSet');
/* Royale Dependency List: flash.__native.te.Char,flash.__native.te.UVTexture,flash.geom.Rectangle,org.villekoskela.utils.RectanglePacker,org.apache.royale.utils.Language*/




/**
 * @constructor
 */
flash.__native.te.CharSet = function() {

this.flash___native_te_CharSet_newChars = [];
this.flash___native_te_CharSet_chars = {};
this.flash___native_te_CharSet_helpRect = new flash.geom.Rectangle();
};


/**
 * @private
 * @type {boolean}
 */
flash.__native.te.CharSet.prototype.flash___native_te_CharSet_dirty = false;


/**
 * @private
 * @type {Array}
 */
flash.__native.te.CharSet.prototype.flash___native_te_CharSet_newChars = null;


/**
 * @type {Object}
 */
flash.__native.te.CharSet.prototype.image = null;


/**
 * @private
 * @type {CanvasRenderingContext2D}
 */
flash.__native.te.CharSet.prototype.flash___native_te_CharSet_ctx = null;


/**
 * @private
 * @type {Object}
 */
flash.__native.te.CharSet.prototype.flash___native_te_CharSet_chars = null;


/**
 * @private
 * @type {number}
 */
flash.__native.te.CharSet.prototype.flash___native_te_CharSet_tsizew = 2048;


/**
 * @private
 * @type {number}
 */
flash.__native.te.CharSet.prototype.flash___native_te_CharSet_tsizeh = 2048;


/**
 * @private
 * @type {org.villekoskela.utils.RectanglePacker}
 */
flash.__native.te.CharSet.prototype.flash___native_te_CharSet_rp = null;


/**
 * @private
 * @type {flash.geom.Rectangle}
 */
flash.__native.te.CharSet.prototype.flash___native_te_CharSet_helpRect = null;


/**
 */
flash.__native.te.CharSet.prototype.debug = function() {
  var /** @type {*} */ img = new Image();
  img.src = this.image.toDataURL();
  document.body.appendChild(/* implicit cast */ org.apache.royale.utils.Language.as(img, Node, true));
};


/**
 * @param {flash.__native.te.Char} c
 */
flash.__native.te.CharSet.prototype.add = function(c) {
  var /** @type {flash.__native.te.UVTexture} */ t = this.getTexture(c);
  if (t == null) {
    t = new flash.__native.te.UVTexture();
    t.font = c.font;
    t.fontSize = c.size;
    t.v = c.v;
    this.flash___native_te_CharSet_newChars.push(t);
    this.flash___native_te_CharSet_dirty = true;
    this.flash___native_te_CharSet_chars[c.v + c.font] = t;
  }
  c.texture = t;
};


/**
 * @param {flash.__native.te.Char} c
 * @return {flash.__native.te.UVTexture}
 */
flash.__native.te.CharSet.prototype.getTexture = function(c) {
  var /** @type {flash.__native.te.UVTexture} */ t = /* implicit cast */ org.apache.royale.utils.Language.as(this.flash___native_te_CharSet_chars[c.v + c.font], flash.__native.te.UVTexture, true);
  if (t && t.fontSize >= c.size) {
    return t;
  }
  return null;
};


/**
 */
flash.__native.te.CharSet.prototype.rebuild = function() {
  if (this.flash___native_te_CharSet_dirty) {
    if (this.image == null) {
      this.image = document.createElement("canvas");
      this.flash___native_te_CharSet_ctx = this.image.getContext("2d");
      this.image.width = this.flash___native_te_CharSet_tsizew;
      this.image.height = this.flash___native_te_CharSet_tsizeh;
      this.flash___native_te_CharSet_ctx.fillStyle = "rgba(255, 255, 255, 1)";
      this.flash___native_te_CharSet_ctx.textBaseline = "top";
      this.flash___native_te_CharSet_rp = new org.villekoskela.utils.RectanglePacker(this.flash___native_te_CharSet_tsizew, this.flash___native_te_CharSet_tsizeh, 1);
    }
    var /** @type {number} */ befnum = this.flash___native_te_CharSet_rp.rectangleCount;
    var /** @type {number} */ len = (this.flash___native_te_CharSet_newChars.length) >> 0;
    for (var /** @type {number} */ i = 0; i < len; i++) {
      var /** @type {flash.__native.te.UVTexture} */ t = /* implicit cast */ org.apache.royale.utils.Language.as(this.flash___native_te_CharSet_newChars[i], flash.__native.te.UVTexture, true);
      this.flash___native_te_CharSet_ctx.font = t.fontSize + "px " + t.font;
      var /** @type {TextMetrics} */ measure = this.flash___native_te_CharSet_ctx.measureText(t.v);
      t.width = (measure.width + 1) >> 0;
      t.height = t.fontSize;
      t.xadvance = t.width;
      this.flash___native_te_CharSet_rp.insertRectangle(t.width, t.height, (befnum + i) >> 0);
    }
    this.flash___native_te_CharSet_rp.packRectangles(false);
    for (i = 0; i < len; i++) {
      t = /* implicit cast */ org.apache.royale.utils.Language.as(this.flash___native_te_CharSet_newChars[i], flash.__native.te.UVTexture, true);
      this.flash___native_te_CharSet_rp.getRectangle((befnum + len - i - 1) >> 0, this.flash___native_te_CharSet_helpRect);
      this.flash___native_te_CharSet_ctx.font = t.fontSize + "px " + t.font;
      this.flash___native_te_CharSet_ctx.fillText(t.v, this.flash___native_te_CharSet_helpRect.x, this.flash___native_te_CharSet_helpRect.y);
      t.u0 = this.flash___native_te_CharSet_helpRect.x;
      t.v0 = this.flash___native_te_CharSet_helpRect.y;
      t.u1 = this.flash___native_te_CharSet_helpRect.x + this.flash___native_te_CharSet_helpRect.width;
      t.v1 = this.flash___native_te_CharSet_helpRect.y + this.flash___native_te_CharSet_helpRect.height;
    }
    if (this.image._texture) {
      this.image._texture.dirty = true;
    }
    this.image.dirty = true;
    this.flash___native_te_CharSet_newChars = [];
    this.flash___native_te_CharSet_dirty = false;
  }
};


/**
 * Metadata
 *
 * @type {Object.<string, Array.<Object>>}
 */
flash.__native.te.CharSet.prototype.ROYALE_CLASS_INFO = { names: [{ name: 'CharSet', qName: 'flash.__native.te.CharSet', kind: 'class' }] };



/**
 * Reflection
 *
 * @return {Object.<string, Function>}
 */
flash.__native.te.CharSet.prototype.ROYALE_REFLECTION_INFO = function () {
  return {
    variables: function () {
      return {
        'image': { type: 'Object', get_set: function (/** flash.__native.te.CharSet */ inst, /** * */ v) {return v !== undefined ? inst.image = v : inst.image;}}
      };
    },
    methods: function () {
      return {
        'CharSet': { type: '', declaredBy: 'flash.__native.te.CharSet'},
        'debug': { type: 'void', declaredBy: 'flash.__native.te.CharSet'},
        'add': { type: 'void', declaredBy: 'flash.__native.te.CharSet', parameters: function () { return [ 'flash.__native.te.Char', false ]; }},
        'getTexture': { type: 'flash.__native.te.UVTexture', declaredBy: 'flash.__native.te.CharSet', parameters: function () { return [ 'flash.__native.te.Char', false ]; }},
        'rebuild': { type: 'void', declaredBy: 'flash.__native.te.CharSet'}
      };
    }
  };
};
/**
 * @const
 * @type {number}
 */
flash.__native.te.CharSet.prototype.ROYALE_COMPILE_FLAGS = 9;
